<!DOCTYPE html>
<html>

<head>
    <title>标记轨迹数据点</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    <!-- Leaflet.awesome-markers plugin v2.0 -->

</head>

<body>
    <div id="map" style="width: 100%; height: 100%;"></div>

    <div style="float: left;">hello</div>

    <form id="formType" onsubmit="return false"
        style="position: fixed;right: 50px;top: 20px;background-color: aliceblue;padding-right: 10px;">
        <input type="radio" name="type" value="activity" checked="checked">驻足活动点<br>
        <input type="radio" name="type" value="move">移动点<br>
        <input type="radio" name="type" value="slow">慢速移动点<br>
        <input type="radio" name="type" value="tempory">暂时停止点<br>
        <input type="submit" value="Submit">
    </form>

</body>

<script>
    // 生成地图
    var mapOptions = {
        center: [39.984094, 116.319236],
        zoom: 12
    }
    var map = new L.map('map', mapOptions);

    var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    map.addLayer(layer);

    // 初始化数据, 并生成热力图和路线图
    var data
    $.ajaxSetup({ async: false });
    $.get("http://localhost:5000/data", function (res) {
        data = res
    })
    makeHeatMap(data)
    makeLine(data)

    // 一些全局变量
    var markers = []

    function makeHeatMap(data) {
        var latlngs = []
        for (p of data) {
            latlngs.push([p.lat, p.lng])
        }

        L.heatLayer(latlngs, { "blur": 15, "maxZoom": 18, "minOpacity": 0.5, "radius": 25 }).addTo(map)
    }

    function makeLine(data) {
        var latlngs = []
        var trackID = 1

        for (p of data) {
            if (trackID != p.trackID) {
                L.polyline(latlngs, { weight: 1, color: 'blue', opacity: 0.5 }).addTo(map)
                latlngs = []
                latlngs.push([p.lat, p.lng])
                trackID = trackID + 1
            }
            else {
                latlngs.push([p.lat, p.lng])
            }
        }
    }

    function makeMarker(index, trackID) {
        // 清除上一次的marker
        for (marker of markers) {
            map.removeLayer(marker)
        }
        markers = []

        // 创建不同颜色的icon
        var LeafIcon = L.Icon.extend({
            options: {
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            }
        });
        var greenIcon = new LeafIcon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png'
        })
        var redIcon = new LeafIcon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png'
        })
        var blueIcon = new LeafIcon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png'
        })

        var track = data.filter(val => val.trackID == trackID)
        for (let p of track) {
            var msg = 'index: ' + p.index.toString() + '\r' +
                'lat: ' + p.lat.toString() + '\r' +
                'lng: ' + p.lng.toString() + '\r' +
                'datatime: ' + p.datatime + '\r' +
                'type: ' + p.type + '\r'

            let markercolor
            if (p.index < index) {
                marker = new L.Marker([p.lat, p.lng], { icon: greenIcon }).bindPopup(msg).openPopup()
            } else if (p.index == index) {
                marker = new L.Marker([p.lat, p.lng], { icon: redIcon }).bindPopup(msg).openPopup()
            } else if (p.index > index) {
                marker = new L.Marker([p.lat, p.lng], { icon: blueIcon }).bindPopup(msg).openPopup()
            }


            // 创建marker

            markers.push(marker)
        }
        for (marker of markers) {
            map.addLayer(marker)
        }
    }

    function marking() {
        function* dataIter(data) {
            for (p of data) {
                yield p
            }
        }

        var dataI = dataIter(data)
        var trackID = 1
        $('form').submit(function (event) {
            var point = dataI.next().value
            makeMarker(point.index, point.trackID)
            point.type = $('form').serializeArray()[0].value
            console.log(point)
        })
    }

    marking()

</script>

</html>